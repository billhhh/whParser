package com.Parser;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import org.apache.http.client.ClientProtocolException;
import org.htmlparser.Parser;
import org.htmlparser.filters.AndFilter;
import org.htmlparser.filters.HasAttributeFilter;
import org.htmlparser.filters.TagNameFilter;
import org.htmlparser.util.NodeList;
import org.htmlparser.util.ParserException;

public class parseProDetail {
	
	private String pageContent = null;
	private Map<String,String> detailListMap = null;
	private String price;
	private String url;
	
	//爬取detail页面内容
	public void setUrl(String link) {
		//根据url得到商品页面，返回页面主体
		try {
			readPage rp = new readPage(link);  //传入link
			url=link;
			
			//根据url得到商品页面，返回页面主体
			this.pageContent = rp.getPageContent();//pageContent就是html内容
//			System.out.println(pageContent);
			
			detailListMap = new HashMap<String, String>();
			
		} catch (ClientProtocolException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}//pageContent就是html内容

	}
	
	
	
	
	public String getPrice() throws ParserException{
		setPrice();
		return this.price;
	}
	
	
	//返回detail的hashmap
	public Map<String,String> getDetailListMap() throws ParserException{
		//既然已经得到特定URL的pagecontent，那就可以正式爬取真正有用的内容了
		setDetailList();
		return this.detailListMap;
	}
	
	
	
	
	/*取得价格*/
	private boolean setPrice(){
		
		try {
			Parser p = new Parser(pageContent);
			
			/*各种过滤器*/
			AndFilter priceTag = new AndFilter(new TagNameFilter("span"),new HasAttributeFilter("id","salePriceTag"));
			//System.out.println("priceTag == "+priceTag);
			NodeList nl = p.parse(priceTag);
			//System.out.println("nl == "+nl);
			//System.out.println("nl.size == "+nl.size());
			
			if(nl.size()>0)
				price = nl.elementAt(0).toPlainTextString();   //这一句总报错
			else
				return false;
			
//			System.out.println(nl.elementAt(0).toPlainTextString());
		} catch (ParserException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		return true;
	}
	
	
	
	
	
	//get之前先set详细list
	private void setDetailList() throws ParserException{
		String detailCache[] = null;
		Parser p = new Parser(pageContent); //pageContent就是html内容
		
		if(setPrice()==false)  //把每个鞋子详情的价格搞进去了
			return ;
			
//		System.out.println(url);
//		System.out.println("price == "+price);
		
		/*各种过滤器*/
		AndFilter detailTag = new AndFilter(new TagNameFilter("div"),new HasAttributeFilter("class","mall_goods_foursort_style"));
		TagNameFilter t = new TagNameFilter("div");
		
		//找到detail
		NodeList nl = p.parse(detailTag);
		if(nl.size()==0)
			return ;
		
		NodeList detailNodeList = nl.elementAt(0).getChildren().extractAllNodesThatMatch(t);
//		System.out.println("elementAt(0) "+nl.elementAt(0).toPlainTextString());
//		System.out.println("getChildren "+nl.elementAt(0).getChildren().toString());
//		System.out.println("extractAllNodesThatMatch "+nl.elementAt(0).getChildren().extractAllNodesThatMatch(t).toString());
		
		/*处理字符，以":"为分割点，存入map*/
		for(int i = 1; i < detailNodeList.size()-1; i++){
			detailCache = detailNodeList.elementAt(i).toPlainTextString().split("：");
			detailListMap.put(detailCache[0], detailCache[1]);
		}
		detailListMap.put("price", price);
		
	}
	
	
}
